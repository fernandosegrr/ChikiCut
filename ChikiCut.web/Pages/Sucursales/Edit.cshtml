@page
@model ChikiCut.Web.Pages.Sucursales.EditModel
@{
    ViewData["Title"] = "Editar sucursal";
}

<h1>Editar sucursal</h1>

<div class="row">
    <div class="col-md-8">
        <form method="post">
            <input type="hidden" asp-for="Sucursal.Id" />
            <input type="hidden" asp-for="Sucursal.CreatedAt" />
            <input type="hidden" asp-for="Sucursal.Country" />
            <input type="hidden" asp-for="Sucursal.OpeningHours" />
            
            <div asp-validation-summary="All" class="text-danger"></div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label asp-for="Sucursal.Code" class="form-label"></label>
                        <input asp-for="Sucursal.Code" class="form-control" />
                        <span asp-validation-for="Sucursal.Code" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label asp-for="Sucursal.Name" class="form-label"></label>
                        <input asp-for="Sucursal.Name" class="form-control" />
                        <span asp-validation-for="Sucursal.Name" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label asp-for="Sucursal.RazonSocial" class="form-label"></label>
                        <input asp-for="Sucursal.RazonSocial" class="form-control" />
                        <span asp-validation-for="Sucursal.RazonSocial" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label asp-for="Sucursal.Rfc" class="form-label"></label>
                        <input asp-for="Sucursal.Rfc" class="form-control" />
                        <span asp-validation-for="Sucursal.Rfc" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label asp-for="Sucursal.Phone" class="form-label"></label>
                        <input asp-for="Sucursal.Phone" class="form-control" />
                        <span asp-validation-for="Sucursal.Phone" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label asp-for="Sucursal.Email" class="form-label"></label>
                        <input asp-for="Sucursal.Email" class="form-control" />
                        <span asp-validation-for="Sucursal.Email" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label asp-for="Sucursal.AddressLine1" class="form-label"></label>
                        <input asp-for="Sucursal.AddressLine1" class="form-control" />
                        <span asp-validation-for="Sucursal.AddressLine1" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label asp-for="Sucursal.AddressLine2" class="form-label"></label>
                        <input asp-for="Sucursal.AddressLine2" class="form-control" />
                        <span asp-validation-for="Sucursal.AddressLine2" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label asp-for="Sucursal.City" class="form-label"></label>
                        <input asp-for="Sucursal.City" class="form-control" />
                        <span asp-validation-for="Sucursal.City" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label asp-for="Sucursal.State" class="form-label"></label>
                        <input asp-for="Sucursal.State" class="form-control" />
                        <span asp-validation-for="Sucursal.State" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label asp-for="Sucursal.PostalCode" class="form-label"></label>
                        <input asp-for="Sucursal.PostalCode" class="form-control" />
                        <span asp-validation-for="Sucursal.PostalCode" class="text-danger"></span>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" asp-for="Sucursal.IsActive" class="form-check-input" />
                        <label asp-for="Sucursal.IsActive" class="form-check-label"></label>
                        <span asp-validation-for="Sucursal.IsActive" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <!-- Sección de Horarios de Atención -->
            <hr />
            <h5>Horarios de Atención</h5>
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row">
                                <!-- Lunes -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Lunes</label>
                                    <div class="row">
                                        <div class="col-6">
                                            <input type="time" id="Monday.Open" name="Monday.Open" class="form-control" placeholder="Apertura" />
                                        </div>
                                        <div class="col-6">
                                            <input type="time" id="Monday.Close" name="Monday.Close" class="form-control" placeholder="Cierre" />
                                        </div>
                                    </div>
                                </div>
                                <!-- Martes -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Martes</label>
                                    <div class="row">
                                        <div class="col-6">
                                            <input type="time" id="Tuesday.Open" name="Tuesday.Open" class="form-control" placeholder="Apertura" />
                                        </div>
                                        <div class="col-6">
                                            <input type="time" id="Tuesday.Close" name="Tuesday.Close" class="form-control" placeholder="Cierre" />
                                        </div>
                                    </div>
                                </div>
                                <!-- Miércoles -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Miércoles</label>
                                    <div class="row">
                                        <div class="col-6">
                                            <input type="time" id="Wednesday.Open" name="Wednesday.Open" class="form-control" placeholder="Apertura" />
                                        </div>
                                        <div class="col-6">
                                            <input type="time" id="Wednesday.Close" name="Wednesday.Close" class="form-control" placeholder="Cierre" />
                                        </div>
                                    </div>
                                </div>
                                <!-- Jueves -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Jueves</label>
                                    <div class="row">
                                        <div class="col-6">
                                            <input type="time" id="Thursday.Open" name="Thursday.Open" class="form-control" placeholder="Apertura" />
                                        </div>
                                        <div class="col-6">
                                            <input type="time" id="Thursday.Close" name="Thursday.Close" class="form-control" placeholder="Cierre" />
                                        </div>
                                    </div>
                                </div>
                                <!-- Viernes -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Viernes</label>
                                    <div class="row">
                                        <div class="col-6">
                                            <input type="time" id="Friday.Open" name="Friday.Open" class="form-control" placeholder="Apertura" />
                                        </div>
                                        <div class="col-6">
                                            <input type="time" id="Friday.Close" name="Friday.Close" class="form-control" placeholder="Cierre" />
                                        </div>
                                    </div>
                                </div>
                                <!-- Sábado -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Sábado</label>
                                    <div class="row">
                                        <div class="col-6">
                                            <input type="time" id="Saturday.Open" name="Saturday.Open" class="form-control" placeholder="Apertura" />
                                        </div>
                                        <div class="col-6">
                                            <input type="time" id="Saturday.Close" name="Saturday.Close" class="form-control" placeholder="Cierre" />
                                        </div>
                                    </div>
                                </div>
                                <!-- Domingo -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Domingo</label>
                                    <div class="row">
                                        <div class="col-6">
                                            <input type="time" id="Sunday.Open" name="Sunday.Open" class="form-control" placeholder="Apertura" />
                                        </div>
                                        <div class="col-6">
                                            <input type="time" id="Sunday.Close" name="Sunday.Close" class="form-control" placeholder="Cierre" />
                                        </div>
                                    </div>
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="checkbox" id="sundayClosed" onchange="toggleSundayFields()">
                                        <label class="form-check-label" for="sundayClosed">
                                            Domingo cerrado
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botón para aplicar horarios predefinidos -->
            <div class="mt-3">
                <button type="button" class="btn btn-outline-secondary" onclick="setDefaultHours()">
                    <i class="bi bi-clock"></i> Aplicar Horarios Predefinidos
                </button>
                <small class="text-muted ms-2">Lun-Vie: 9:00-17:00, Sáb: 9:00-13:00, Dom: Cerrado</small>
            </div>

            <div class="mt-4">
                <button type="submit" class="btn btn-primary">Guardar</button>
                <a asp-page="Index" class="btn btn-secondary ms-2">Volver</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        // Función para establecer horarios predefinidos
        function setDefaultHours() {
            // Lunes a Viernes: 9:00 - 17:00
            var weekdays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            weekdays.forEach(function(day) {
                document.getElementById(day + '.Open').value = '09:00';
                document.getElementById(day + '.Close').value = '17:00';
            });
            
            // Sábado: 9:00 - 13:00
            document.getElementById('Saturday.Open').value = '09:00';
            document.getElementById('Saturday.Close').value = '13:00';
            
            // Domingo: Cerrado
            document.getElementById('Sunday.Open').value = '';
            document.getElementById('Sunday.Close').value = '';
            document.getElementById('sundayClosed').checked = true;
            toggleSundayFields();
        }
        
        // Función para alternar campos del domingo
        function toggleSundayFields() {
            var sundayOpen = document.getElementById('Sunday.Open');
            var sundayClose = document.getElementById('Sunday.Close');
            var isClosed = document.getElementById('sundayClosed').checked;
            
            if (isClosed) {
                sundayOpen.value = '';
                sundayClose.value = '';
                sundayOpen.disabled = true;
                sundayClose.disabled = true;
            } else {
                sundayOpen.disabled = false;
                sundayClose.disabled = false;
            }
        }

        // Cargar los horarios existentes al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            var openingHoursJson = '@Html.Raw(Model.Sucursal.OpeningHours ?? "{}")';
            
            try {
                var openingHours = JSON.parse(openingHoursJson);
                
                // Mapeo de días
                var dayMapping = {
                    'mon': 'Monday',
                    'tue': 'Tuesday',
                    'wed': 'Wednesday',
                    'thu': 'Thursday',
                    'fri': 'Friday',
                    'sat': 'Saturday',
                    'sun': 'Sunday'
                };

                // Cargar los horarios existentes en los campos
                for (var dayKey in dayMapping) {
                    if (openingHours[dayKey] && openingHours[dayKey].length > 0) {
                        var slot = openingHours[dayKey][0]; // Tomar el primer slot
                        var dayName = dayMapping[dayKey];
                        
                        var openField = document.getElementById(dayName + '.Open');
                        var closeField = document.getElementById(dayName + '.Close');
                        
                        if (openField && closeField && slot.open && slot.close) {
                            openField.value = slot.open;
                            closeField.value = slot.close;
                        }
                    }
                }
                
                // Verificar si domingo está cerrado
                if (!openingHours.sun || openingHours.sun.length === 0) {
                    document.getElementById('sundayClosed').checked = true;
                    toggleSundayFields();
                }
                
            } catch (e) {
                console.log('Error parsing opening hours:', e);
                // Si hay error parseando, aplicar horarios predefinidos
                setDefaultHours();
            }
        });

        // Manejar el envío del formulario
        document.querySelector('form').addEventListener('submit', function(e) {
            // Construir el JSON de horarios antes de enviar
            var openingHours = {
                mon: [],
                tue: [],
                wed: [],
                thu: [],
                fri: [],
                sat: [],
                sun: []
            };

            // Mapeo de días en inglés a sus abreviaciones
            var dayMapping = {
                'Monday': 'mon',
                'Tuesday': 'tue',
                'Wednesday': 'wed',
                'Thursday': 'thu',
                'Friday': 'fri',
                'Saturday': 'sat',
                'Sunday': 'sun'
            };

            // Recoger los horarios de cada día
            for (var day in dayMapping) {
                var openField = document.querySelector(`input[name="${day}.Open"]`);
                var closeField = document.querySelector(`input[name="${day}.Close"]`);
                
                // Solo agregar horarios si los campos están habilitados y tienen valores
                if (!openField.disabled && !closeField.disabled && openField.value && closeField.value) {
                    openingHours[dayMapping[day]].push({
                        open: openField.value,
                        close: closeField.value
                    });
                }
            }

            // Asignar el JSON generado al campo oculto
            document.querySelector('input[name="Sucursal.OpeningHours"]').value = JSON.stringify(openingHours);
        });
    </script>
}
